name: Build & Publish WSL2 Image

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build . -t eda-wsl-debian

      - name: Export container filesystem to .wsl
        run: |
          docker run -t --name wsl_export eda-wsl-debian ls /
          docker export wsl_export -o eda.tar
          docker rm wsl_export
          mv eda.tar eda.wsl

      - uses: actions/upload-artifact@v4
        with:
          name: eda-wsl2
          path: eda.wsl

      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: eda.wsl
          asset_name: eda-${{ github.ref_name }}.wsl
          tag: ${{ github.ref_name }}
