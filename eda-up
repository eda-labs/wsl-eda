#!/bin/bash
# eda-up - Start EDA playground environment
# This script clones the EDA playground and starts the environment

set -e

BLUE='\033[34m'
GREEN='\033[32m'
YELLOW='\033[33m'
RED='\033[31m'
NC='\033[0m'

PLAYGROUND_DIR="$HOME/nokia-eda/playground"
EDA_CONFIG_DIR="/opt/eda"

log() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

ensure_docker_ready() {
    log "Waiting for Docker to be ready..."
    local max_attempts=30
    local attempt=0
    while ! docker info >/dev/null 2>&1; do
        attempt=$((attempt + 1))
        if [ $attempt -ge $max_attempts ]; then
            log_error "Docker is not available after $max_attempts attempts"
            exit 1
        fi
        sleep 2
    done
    log_success "Docker is ready"
}

dump_system_info() {
    log "System information:"
    echo "  CPUs: $(nproc)"
    echo "  Memory: $(free -h | awk '/^Mem:/ {print $2}')"
    echo "  Disk: $(df -h / | awk 'NR==2 {print $4}') available"
}

check_memory() {
    local mem_kb=$(awk '/^MemTotal:/ {print $2}' /proc/meminfo)
    local mem_gb=$((mem_kb / 1024 / 1024))
    local required_gb=12

    if [ "$mem_gb" -lt "$required_gb" ]; then
        log_error "Insufficient memory: ${mem_gb}GB available, ${required_gb}GB required"
        log_error "Configure memory in WSL Settings (search 'WSL Settings' in Start menu)"
        exit 1
    fi
}

clone_playground() {
    if [ -d "$PLAYGROUND_DIR" ]; then
        log "Playground directory exists, updating..."
        cd "$PLAYGROUND_DIR"
        git pull --ff-only || true
    else
        log "Cloning EDA playground..."
        git clone https://github.com/nokia-eda/playground.git "$PLAYGROUND_DIR"
        cd "$PLAYGROUND_DIR"
    fi
    log_success "Playground ready at $PLAYGROUND_DIR"
}

setup_overrides() {
    log "Setting up WSL overrides..."

    # Copy WSL-specific override files to playground
    if [ -d "$EDA_CONFIG_DIR" ]; then
        cp "$EDA_CONFIG_DIR/overrides.mk" "$PLAYGROUND_DIR/" 2>/dev/null || true
        cp "$EDA_CONFIG_DIR/wsl-kpt-setters.yaml" "$PLAYGROUND_DIR/" 2>/dev/null || true
        cp "$EDA_CONFIG_DIR/engine-config-patch.yaml" "$PLAYGROUND_DIR/" 2>/dev/null || true
    fi

    log_success "Overrides configured"
}

start_eda() {
    cd "$PLAYGROUND_DIR"

    log "Starting EDA environment..."
    log "This may take several minutes on first run..."

    # Run make try-eda with WSL-specific settings
    # Using KIND (not k3d) as playground defaults to KIND
    # NO_LB=true if MetalLB causes issues in WSL
    make try-eda \
        OVERRIDE_MK="$PLAYGROUND_DIR/overrides.mk" \
        KPT_SETTERS_FILE="$PLAYGROUND_DIR/wsl-kpt-setters.yaml" \
        SIMULATE=true
}

show_help() {
    cat << 'EOF'
eda-up - Start EDA playground environment

Usage: eda-up [OPTIONS]

Options:
    -h, --help      Show this help message
    -u, --update    Update playground repo before starting
    -c, --clean     Remove existing playground and start fresh
    -s, --status    Show status of running EDA environment
    --no-simulate   Don't load simulated topology
    --setup-only    Clone repo and apply patches, but don't deploy EDA

Examples:
    eda-up              # Start EDA environment
    eda-up --clean      # Fresh start
    eda-up --status     # Check status
    eda-up --setup-only # Prepare playground without deploying

EOF
}

check_status() {
    if ! command -v kubectl &> /dev/null; then
        log_error "kubectl not found"
        exit 1
    fi

    log "Checking EDA status..."

    # Check if KIND cluster exists
    if kind get clusters 2>/dev/null | grep -q "eda-demo"; then
        log_success "KIND cluster 'eda-demo' is running"

        # Switch context
        kubectl config use-context kind-eda-demo 2>/dev/null || true

        # Show pod status
        echo ""
        echo "EDA Pods:"
        kubectl get pods -n eda-system 2>/dev/null || echo "  Unable to get pods"

        echo ""
        echo "Access EDA at: https://localhost:9443"
        echo "Default credentials: admin / admin"
    else
        log_warn "EDA cluster is not running. Run 'eda-up' to start."
    fi
}

# Parse arguments
CLEAN=false
UPDATE=false
STATUS=false
NO_SIMULATE=false
SETUP_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -c|--clean)
            CLEAN=true
            shift
            ;;
        -u|--update)
            UPDATE=true
            shift
            ;;
        -s|--status)
            STATUS=true
            shift
            ;;
        --no-simulate)
            NO_SIMULATE=true
            shift
            ;;
        --setup-only)
            SETUP_ONLY=true
            shift
            ;;
        *)
            log_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Handle status check
if [ "$STATUS" = true ]; then
    check_status
    exit 0
fi

# Main execution
dump_system_info
check_memory
ensure_docker_ready

# Clean if requested
if [ "$CLEAN" = true ] && [ -d "$PLAYGROUND_DIR" ]; then
    log_warn "Removing existing playground..."

    # Delete KIND cluster if exists
    if kind get clusters 2>/dev/null | grep -q "eda-demo"; then
        log "Deleting existing KIND cluster..."
        kind delete cluster --name eda-demo
    fi

    rm -rf "$PLAYGROUND_DIR"
fi

clone_playground
setup_overrides

# Exit early if setup-only mode
if [ "$SETUP_ONLY" = true ]; then
    log_success "Setup complete. Run 'eda-up' to deploy EDA."
    exit 0
fi

# Modify make command based on options
MAKE_ARGS="SIMULATE=true"
if [ "$NO_SIMULATE" = true ]; then
    MAKE_ARGS=""
fi

cd "$PLAYGROUND_DIR"
log "Starting EDA environment..."
log "This may take several minutes on first run..."

# Run make try-eda
if [ -f "$PLAYGROUND_DIR/overrides.mk" ]; then
    make try-eda OVERRIDE_MK="$PLAYGROUND_DIR/overrides.mk" $MAKE_ARGS
else
    make try-eda $MAKE_ARGS
fi

